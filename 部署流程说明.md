# 博客部署流程说明

## ⚠️ 重要提醒
**服务器部署依赖GitHub上的dist文件夹，所以必须把build后的dist提交到GitHub！**

## 推荐方式：使用脚本（一键部署）

```bash
cd /Users/geraldchen/ai/blog
./deploy-production.sh
```

这个脚本会自动完成：

**阶段1：部署前检查**
1. ✅ 确认当前分支为main
2. ✅ 检查是否有未提交的源码改动
3. ✅ 同步远程仓库

**阶段2：本地构建**
4. ✅ 执行npm run build

**阶段3：提交到GitHub**
5. ✅ 确认推送目标分支为main
6. ✅ 确认所有改动已commit（包括dist）
7. ✅ 推送到GitHub
8. ✅ 记录部署的commit hash

**阶段4：服务器部署**
9. ✅ 服务器拉取最新代码
10. ✅ 部署到nginx目录

**阶段5：部署验证**
11. ✅ 检查网站访问状态（HTTP 200）
12. ✅ 检查关键页面（首页、文章列表、关于页）
13. ✅ 显示最后修改时间

## 手动部署流程（分步操作）

### 步骤1：本地构建
```bash
cd /Users/geraldchen/ai/blog
npm run build
```

### 步骤2：提交到GitHub
```bash
# 提交源码改动
git add src/ public/ astro.config.ts package.json # 根据实际修改的文件
git commit -m "描述你的改动"

# ⚠️ 必须再次提交构建产物
git add dist/
git commit -m "Update dist (build output)"

# 推送到GitHub
git push origin main
```

**❌ 常见错误**：只提交了源码，忘记提交dist文件夹

### 步骤3：服务器部署
```bash
sshpass -p 'datayes@123' ssh -p 34567 root@45.63.22.102 \
  "cd /root/blog && git pull origin main && \
   rm -rf /usr/share/nginx/html/* && \
   cp -r /root/blog/dist/* /usr/share/nginx/html/"
```

## 为什么必须提交dist到GitHub？

服务器的部署流程是：
1. 服务器从GitHub拉取代码（包括dist）
2. 直接复制dist文件夹到nginx目录

**不是**在服务器上执行npm run build（服务器没有node环境）

## 验证发布成功

访问网站检查改动是否生效：
- https://chenguangliang.com

## 今天的错误教训（2026-02-13）

❌ **错误流程**：
1. git commit（只提交源码）
2. npm run build（生成新dist）
3. git push（push的不包含新dist）
4. 服务器拉取到旧的dist

✅ **正确流程**：
1. npm run build
2. git add -A（包含src和dist）
3. git commit
4. git push
5. 服务器拉取最新dist并部署

或者直接用 `./deploy-production.sh` 一键搞定。
